name: æ¯æ—¥äº®å…‰ Podcast è‡ªå‹•åŒ–æµç¨‹

on:
  schedule:
    - cron: '0 22 * * *'  # 06:00 å°ç£æ™‚é–“
    - cron: '0 10 * * *'  # 18:00 å°ç£æ™‚é–“
  workflow_dispatch:

env:
  TZ: Asia/Taipei

jobs:
  generate-podcast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libgl1-mesa-glx libglib2.0-0

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install paddleocr==2.7.0.3 paddlepaddle==2.5.2 opencv-python Pillow edge-tts

      - name: Get current date
        id: date
        run: |
          echo "date=$(TZ=Asia/Taipei date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "hour=$(TZ=Asia/Taipei date +'%H')" >> $GITHUB_OUTPUT

      - name: OCR è™•ç†
        run: |
          python scripts/ocr_image_to_text.py

      - name: èªéŸ³åˆæˆ
        run: |
          python scripts/text_to_speech_edge.py

      - name: ç¢ºèªæ˜¯å¦æœ‰è®Šæ›´
        id: verify_changed_files
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git status
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.verify_changed_files.outputs.changed == 'true'
        run: |
          git add --all
          git commit -m "ğŸ™ï¸ Auto update for ${{ steps.date.outputs.date }} ($(TZ=Asia/Taipei date +'%H:%M'))"
          git push