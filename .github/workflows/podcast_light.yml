name: Daily OCR and TTS for æ¯æ—¥äº®å…‰

on:
  schedule:
    - cron: '0 22 * * *'  # å°ç£æ™‚é–“ 06:00ï¼ˆUTC+8ï¼‰ï¼Œå³ UTC 22:00
    - cron: '10 10 * * *' # å°ç£æ™‚é–“ 18:10 æ™šé–“éŸ³æª”ï¼ˆè‹¥éœ€è£œä¸Šï¼‰
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æª¢å‡º Repository
        uses: actions/checkout@v3

      - name: é¡¯ç¤ºç›®å‰ç›®éŒ„èˆ‡åœ–ç‰‡åˆ—è¡¨
        run: |
          echo "ç›®å‰ç›®éŒ„:"
          pwd
          echo "åœ–ç‰‡æ¸…å–®:"
          ls -lh docs/img || true

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: å®‰è£ç³»çµ±ç›¸ä¾å¥—ä»¶ï¼ˆå« PaddleOCR æ‰€éœ€ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-0 libsm6 libxrender1 libxext6 libgl1

      - name: å®‰è£ Python å¥—ä»¶ï¼ˆå« PaddleOCRï¼‰
        run: |
          python -m pip install --upgrade pip
          pip install paddlepaddle==2.5.2 -f https://www.paddlepaddle.org.cn/whl/linux/mkl/avx/stable.html
          pip install paddleocr==2.7.1.3 opencv-python Pillow pytz edge-tts

      - name: é–‹å§‹ OCR è™•ç†
        run: |
          python scripts/ocr_image_to_text.py

      - name: é–‹å§‹èªéŸ³åˆæˆ
        run: |
          python scripts/text_to_speech_edge.py

      - name: é¡¯ç¤ºç”¢å‡ºç›®éŒ„å…§å®¹
        run: |
          echo "==== docs/podcast/ ===="
          ls -R docs/podcast

      - name: è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: æäº¤è®Šæ›´
        run: |
          git add --all
          git commit -m "ğŸ™ï¸ Auto update for $(date +'%Y%m%d') ($(date +'%H:%M'))" || echo "No changes to commit"

      - name: æ¨é€åˆ° GitHub
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main