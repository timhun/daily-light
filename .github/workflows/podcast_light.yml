name: Daily Light Podcast Generator

on:
  schedule:
    - cron: '0 22 * * *'   # 台灣早上 6 點 (UTC 22:00)
    - cron: '0 10 * * *'   # 台灣晚上 6 點 (UTC 10:00)
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-22.04

    env:
      PODCAST_MODE: tw
      MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      GROK_API_URL: ${{ secrets.GROK_API_URL }}
      B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
      B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
      B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
      B2_BUCKET_URL: ${{ secrets.B2_BUCKET_URL }}
      B2_FOLDER_PREFIX: ${{ secrets.B2_FOLDER_PREFIX }}  # 可選，根據需求添加

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ffmpeg libgl1 libglib2.0-0 \
          tesseract-ocr tesseract-ocr-chi-tra tesseract-ocr-chi-sim

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install b2sdk mutagen edge-tts feedgen  # 明確指定依賴
        pip install -r requirements.txt  # 如果有額外依賴

    - name: Show working directory and image list
      run: |
        echo "目前目錄:"
        pwd
        echo "圖片清單:"
        ls -lh docs/img

    - name: OCR 處理
      run: |
        echo "開始 OCR 處理..."
        python scripts/ocr_image_to_text.py || echo "OCR 處理失敗，但繼續執行"

    - name: 語音合成與後續處理
      run: |
        echo "開始語音合成與後續處理..."
        python scripts/text_to_speech_edge.py || echo "語音合成失敗，但繼續執行"

    - name: 上傳到 B2
      run: |
        echo "開始上傳到 B2..."
        python scripts/upload_to_b2.py || echo "上傳失敗，但繼續執行"

    - name: 生成 RSS Feed
      run: |
        echo "開始生成 RSS Feed..."
        python scripts/generate_rss.py || echo "RSS 生成失敗，但繼續執行"

    - name: Git commit and push
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add --all
        git commit -m "🎙️ Auto update for $(date +'%Y%m%d (%H:%M)')" || echo "No changes to commit"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Podcast Generation Failed',
            body: 'The Daily Light Podcast generation workflow failed at ${{ github.run_id }}. Please check the logs.',
            labels: ['bug']
          })