name: Daily Light Podcast Generator

on:
  schedule:
    - cron: '0 22 * * *'   # å°ç£æ—©ä¸Š 6 é» (UTC 22:00)
    - cron: '0 10 * * *'   # å°ç£æ™šä¸Š 6 é» (UTC 10:00)
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-22.04

    env:
      PODCAST_MODE: tw
      MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      GROK_API_URL: ${{ secrets.GROK_API_URL }}
      B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
      B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
      B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
      B2_BUCKET_URL: ${{ secrets.B2_BUCKET_URL }}
      B2_FOLDER_PREFIX: ${{ secrets.B2_FOLDER_PREFIX }}  # å¯é¸ï¼Œæ ¹æ“šéœ€æ±‚æ·»åŠ 

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ffmpeg libgl1 libglib2.0-0 \
          tesseract-ocr tesseract-ocr-chi-tra tesseract-ocr-chi-sim

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install b2sdk mutagen edge-tts feedgen  # æ˜ç¢ºæŒ‡å®šä¾è³´
        pip install -r requirements.txt  # å¦‚æœæœ‰é¡å¤–ä¾è³´

    - name: Show working directory and image list
      run: |
        echo "ç›®å‰ç›®éŒ„:"
        pwd
        echo "åœ–ç‰‡æ¸…å–®:"
        ls -lh docs/img

    - name: OCR è™•ç†
      run: |
        echo "é–‹å§‹ OCR è™•ç†..."
        python scripts/ocr_image_to_text.py || echo "OCR è™•ç†å¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"

    - name: èªéŸ³åˆæˆèˆ‡å¾ŒçºŒè™•ç†
      run: |
        echo "é–‹å§‹èªéŸ³åˆæˆèˆ‡å¾ŒçºŒè™•ç†..."
        python scripts/text_to_speech_edge.py || echo "èªéŸ³åˆæˆå¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"

    - name: ä¸Šå‚³åˆ° B2
      run: |
        echo "é–‹å§‹ä¸Šå‚³åˆ° B2..."
        python scripts/upload_to_b2.py || echo "ä¸Šå‚³å¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"

    - name: ç”Ÿæˆ RSS Feed
      run: |
        echo "é–‹å§‹ç”Ÿæˆ RSS Feed..."
        python scripts/generate_rss.py || echo "RSS ç”Ÿæˆå¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"

    - name: Git commit and push
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add --all
        git commit -m "ğŸ™ï¸ Auto update for $(date +'%Y%m%d (%H:%M)')" || echo "No changes to commit"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Podcast Generation Failed',
            body: 'The Daily Light Podcast generation workflow failed at ${{ github.run_id }}. Please check the logs.',
            labels: ['bug']
          })